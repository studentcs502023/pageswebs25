<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Mesas y Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-mesa {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--secondary-color);
        }
        
        .card-mesa:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-mesa.libre {
            border-left-color: var(--success-color);
        }
        
        .card-mesa.ocupada {
            border-left-color: var(--accent-color);
        }
        
        .card-mesa.deshabilitada {
            border-left-color: #95a5a6;
        }
        
        .estado-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .estado-libre {
            background-color: #e8f5e9;
            color: var(--success-color);
        }
        
        .estado-ocupada {
            background-color: #ffebee;
            color: var(--accent-color);
        }
        
        .estado-deshabilitada {
            background-color: #f5f5f5;
            color: #9e9e9e;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-custom thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .mesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-error {
            border: 1px solid var(--accent-color) !important;
        }
        
        .error-message {
            color: var(--accent-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .temporizador-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .temporizador-activo {
            color: #dc3545;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .mesas-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1>üçΩÔ∏è Sistema de Gesti√≥n de Mesas</h1>
        <p class="lead">Administra tus mesas y reservas de forma eficiente</p>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Mesas Disponibles</h2>
                    <button type="button" class="btn btn-primary-custom text-white" data-bs-toggle="modal" data-bs-target="#modalMesas">
                        + Agregar Mesa
                    </button>
                </div>
           
                <div id="bodyData" class="mesas-grid"></div>
                
                <div class="form-container">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Gesti√≥n de Reservas</h2>
                        <button id="btnReserva" class="btn btn-success" onclick="mostrarFormularioNew()">
                            ‚ûï Hacer Reserva
                        </button>
                    </div>
                    
                    <div id="formulario" style="display: none;">
                        <h3 class="mb-4">Registro de Reserva</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="idreserva" class="form-label">ID √∫nico de la reserva</label>
                                <input type="number" id="idreserva" class="form-control" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="select-mesa" class="form-label">Seleccione una mesa</label>
                                <select id="select-mesa" class="form-select" required>
                                    <option value="">Seleccione una mesa</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nombreCliente" class="form-label">Nombre del cliente</label>
                                <input type="text" id="nombreCliente" class="form-control" required>
                                <div id="errorNombre" class="error-message">‚ö†Ô∏è El nombre es obligatorio</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="NumReservas" class="form-label">N√∫mero de personas</label>
                                <input type="number" id="NumReservas" class="form-control" required min="1">
                                <div id="errorNombre1" class="error-message">‚ö†Ô∏è El n√∫mero de personas es obligatorio</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="Datereserva" class="form-label">Fecha de reserva</label>
                                <input type="date" id="Datereserva" class="form-control">
                                <div id="errorNombre2" class="error-message">‚ö†Ô∏è La fecha es obligatoria</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="hora-reserva" class="form-label">Hora de reserva</label>
                                <input type="time" id="hora-reserva" class="form-control" min="08:00" max="20:00">
                                <div id="errorHora" class="error-message">‚ö†Ô∏è La hora es obligatoria (entre 8:00 y 20:00)</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="duracion-reserva" class="form-label">Duraci√≥n estimada</label>
                                <select id="duracion-reserva" class="form-select">
                                    <option value="60">1 hora</option>
                                    <option value="120" selected>2 horas</option>
                                    <option value="180">3 horas</option>
                                    <option value="240">4 horas</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="ocasiones-especiales" class="form-label">Ocasi√≥n especial</label>
                                <select id="ocasiones-especiales" class="form-select">
                                    <option value="cumplea√±os">Cumplea√±os</option>
                                    <option value="Aniversario">Aniversario</option>
                                    <option value="Reunion de Negocios">Reuni√≥n de Negocios</option>
                                    <option value="Boda">Boda</option>
                                    <option value="Despedida">Despedida</option>
                                    <option value="Graduacion">Graduaci√≥n</option>
                                    <option value="Compromiso">Compromiso</option>
                                    <option value="Dia de la Madre">D√≠a de la Madre</option>
                                    <option value="Dia del Padre">D√≠a del Padre</option>
                                    <option value="San Valentin">San Valent√≠n</option>
                                    <option value="Navidad">Navidad</option>
                                    <option value="A√±o Nuevo">A√±o Nuevo</option>
                                </select>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="Notas" class="form-label">Notas para la atenci√≥n</label>
                                <textarea id="Notas" class="form-control" rows="2"></textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="estado" class="form-label">Estado de la reserva</label>
                                <select id="estado" class="form-select">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Confirmada">Confirmada</option>
                                    <option value="Cancelada">Cancelada</option>
                                    <option value="Finalizada">Finalizada</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-4">
                            <button id="save" onclick="guardarNew()" class="btn btn-primary-custom text-white w-50">Guardar</button>
                            
                        </div>
                    </div>
                    
                    <div class="mt-5">
                        <h3 class="mb-3">Reservas Existentes</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-custom">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mesa</th>
                                        <th>Cliente</th>
                                        <th>Personas</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Duraci√≥n</th>
                                        <th>Ocasi√≥n</th>
                                        <th>Notas</th>
                                        <th>Estado</th>
                                        <th>Tiempo</th>
                                        <th>Opciones</th>
                                    </tr>
                                </thead>
                                <tbody id="infoData"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="form-container">
                    <h3>Estad√≠sticas</h3>
                    <div class="d-flex justify-content-around text-center my-4">
                        <div>
                            <div class="fs-1 fw-bold" id="total-mesas">0</div>
                            <div>Total Mesas</div>
                        </div>
                        <div>
                            <div class="fs-1 fw-bold" id="mesas-libres">0</div>
                            <div>Mesas Libres</div>
                        </div>
                        <div>
                            <div class="fs-1 fw-bold" id="total-reservas">0</div>
                            <div>Total Reservas</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4>Reservas de Hoy</h4>
                        <div id="reservas-hoy" class="mt-3">
                            <!-- Las reservas de hoy se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                    <div class="filter mt-4">
                        <h4>Reservas ocupadas y pendientes</h4>
                        <div id="filtroConfirmadas"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar mesas -->
    <div class="modal fade" id="modalMesas" tabindex="-1" aria-labelledby="modalMesasLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMesasLabel">Agregar mesa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-numero" class="form-label">N√∫mero de mesa</label>
                        <input type="number" id="modal-numero" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modal-cantidad" class="form-label">Cantidad de personas</label>
                        <input type="number" id="modal-cantidad" class="form-control" required min="1">
                        <div id="errorCantidad" class="error-message">‚ö†Ô∏è La cantidad debe ser mayor a 0</div>
                    </div>
                    <div class="mb-3">
                        <label for="modal-ubicacion" class="form-label">Ubicaci√≥n</label>
                        <input type="text" id="modal-ubicacion" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-estado" class="form-label">Estado</label>
                        <select id="modal-estado" class="form-select">
                            <option value="Libre">Libre</option>
                            <option value="Deshabilitada">Deshabilitada</option>
                            <option value="Ocupada">Ocupada</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom text-white" id="btnGuardarModal">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar localStorage
        if (!localStorage.getItem("mesas")) {
            localStorage.setItem("mesas", JSON.stringify([]));
        }
        
        if (!localStorage.getItem("reservas")) {
            localStorage.setItem("reservas", JSON.stringify([]));
        }

        let mesas = JSON.parse(localStorage.getItem("mesas"));
        let datos = JSON.parse(localStorage.getItem("reservas"));
        let editIndex = null;
        let temporizadoresActivos = {};

        // ==================== FUNCIONES DEL TEMPORIZADOR ====================
        
        // Iniciar temporizador para una reserva
        function iniciarTemporizador(reservaId, startTime, duracionMinutos) {
            // Limpiar temporizador existente si hay uno
            if (temporizadoresActivos[reservaId]) {
                clearInterval(temporizadoresActivos[reservaId]);
            }
            
            const ahora = Date.now();
            const tiempoTranscurrido = Math.floor((ahora - startTime) / 6); // en minutos
            
            // Si ya pas√≥ el tiempo l√≠mite
            if (tiempoTranscurrido >= duracionMinutos) {
                document.querySelector(`#temporizador-${reservaId}`).innerHTML = 
                    `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
                return;
            }
            
            // Actualizar contador inmediatamente
            actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
            
            // Configurar intervalo para actualizar cada minuto
            temporizadoresActivos[reservaId] = setInterval(() => {
                actualizarContadorTemporizador(reservaId, startTime, duracionMinutos);
            }, 6);
        }
        
        // Actualizar visualizaci√≥n del contador
        function actualizarContadorTemporizador(reservaId, startTime, duracionMinutos) {
            const ahora = Date.now();
            const tiempoTranscurrido = Math.floor((ahora - startTime) / 6); // en minutos
            const tiempoRestante = duracionMinutos - tiempoTranscurrido;
            
            const elemento = document.querySelector(`#temporizador-${reservaId}`);
            if (!elemento) return;
            
            if (tiempoRestante <= 0) {
                elemento.innerHTML = `<span class="temporizador-activo">‚è∞ Tiempo cumplido</span>`;
                clearInterval(temporizadoresActivos[reservaId]);
                delete temporizadoresActivos[reservaId];
                
                // Cambiar estado a "Finalizada" cuando se cumple el tiempo
                const reservaIndex = datos.findIndex(r => r.id == reservaId);
                if (reservaIndex !== -1) {
                    datos[reservaIndex].estado = "Finalizada";
                    localStorage.setItem("reservas", JSON.stringify(datos));
                    
                    // Liberar la mesa
                    const mesaIndex = mesas.findIndex(m => m.numero == datos[reservaIndex].mesa);
                    if (mesaIndex !== -1) {
                        mesas[mesaIndex].estado = "Libre";
                        localStorage.setItem("mesas", JSON.stringify(mesas));
                        pintarDatos();
                    }
                    
                    pintarDatosNew();
                    actualizarEstadisticas();
                }
            } else {
                elemento.innerHTML = `‚åõ ${tiempoRestante} min restantes`;
                
                // Cambiar color si queda poco tiempo (menos de 15 minutos)
                if (tiempoRestante < 15) {
                    elemento.classList.add('temporizador-activo');
                } else {
                    elemento.classList.remove('temporizador-activo');
                }
            }
        }
        
        // Recuperar temporizadores al cargar la p√°gina
        function recuperarTemporizadores() {
            datos.forEach(reserva => {
                if (reserva.startTime && reserva.duracion && 
                    (reserva.estado === "Confirmada" || reserva.estado === "Ocupada")) {
                    iniciarTemporizador(reserva.id, parseInt(reserva.startTime), parseInt(reserva.duracion));
                }
            });
        }
        
        // ==================== FUNCIONES EXISTENTES MODIFICADAS ====================

        // Obtener el siguiente n√∫mero de mesa disponible
        function obtenerSiguienteNumeroMesa() {
            if (mesas.length === 0) return 1;
            const max = Math.max(...mesas.map(m => Number(m.numero)));
            return max > 0 ? max + 1 : 1;
        }

        // Configurar el modal al abrirse
        document.querySelector('[data-bs-target="#modalMesas"]').addEventListener("click", () => {
            editIndex = null;
            document.getElementById("modalMesasLabel").textContent = "Agregar mesa";
            document.getElementById("modal-numero").value = obtenerSiguienteNumeroMesa();
            document.getElementById("modal-cantidad").value = "";
            document.getElementById("modal-ubicacion").value = "";
            document.getElementById("modal-estado").value = "Libre";
            
            // Limpiar errores
            document.getElementById("errorCantidad").style.display = "none";
            document.getElementById("modal-cantidad").classList.remove("input-error");
        });

        // Guardar mesa desde el modal
        const guardarDesdeModal = () => {
            const numero = document.getElementById("modal-numero").value;
            const cantidad = document.getElementById("modal-cantidad").value;
            const ubicacion = document.getElementById("modal-ubicacion").value;
            const estado = document.getElementById("modal-estado").value;
            let isValid = true;
            
            // Validaciones
            if (!cantidad || cantidad <= 0) {
                document.getElementById("modal-cantidad").classList.add('input-error');
                document.getElementById("errorCantidad").style.display = 'block';
                isValid = false;
            }
            
            if (!ubicacion) {
                document.getElementById("modal-ubicacion").classList.add('input-error');
                isValid = false;
            }
            
            if (!isValid) return;
            
            if (editIndex === null) {
                const reg = { numero, cantidad, ubicacion, estado };
                mesas.push(reg);
            } else {
                mesas[editIndex].cantidad = cantidad;
                mesas[editIndex].ubicacion = ubicacion;
                mesas[editIndex].estado = estado;
                editIndex = null;
                document.getElementById("modalMesasLabel").textContent = "Agregar mesa";
            }

            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatos();
            actualizarEstadisticas();
            
            // Cerrar modal usando Bootstrap
            const modal = bootstrap.Modal.getInstance(document.getElementById("modalMesas"));
            modal.hide();
        };

        // Actualizar el select de mesas disponibles
        function actualizarSelectMesas() {
            const selectMesa = document.getElementById("select-mesa");
            selectMesa.innerHTML = '<option value="">Seleccione una mesa</option>';
            
            mesas.forEach((mesa) => {
                if (mesa.estado === "Libre") {
                    const option = document.createElement("option");
                    option.value = mesa.numero;
                    option.textContent = `Mesa ${mesa.numero} - (${mesa.cantidad} personas)`;
                    selectMesa.appendChild(option);
                }
            });
        }

        // Pintar las mesas en el grid
        const pintarDatos = () => {
            const body = document.getElementById("bodyData");
            body.innerHTML = "";
            
            mesas.forEach((item, i) => {
                const card = document.createElement("div");
                card.className = `card-mesa ${item.estado.toLowerCase()}`;
                
                const estadoClass = `estado-badge estado-${item.estado.toLowerCase()}`;
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h4 class="mb-0">Mesa #${item.numero}</h4>
                        <span class="${estadoClass}">${item.estado}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Capacidad:</strong> ${item.cantidad} personas
                    </div>
                    <div class="mb-3">
                        <strong>Ubicaci√≥n:</strong> ${item.ubicacion}
                    </div>
                    <div class="botones d-flex gap-2">
                        <button class="btn btn-sm btn-warning flex-fill" onclick="editarMesa(${i})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-danger flex-fill" onclick="eliminarMesa(${i})">üóëÔ∏è Eliminar</button>
                        ${item.estado !== "Deshabilitada" ? 
                            `<button class="btn btn-sm btn-success flex-fill" onclick="reservarMesa(${i})">üìå Reservar</button>` : ''}
                    </div>
                `;
                
                body.appendChild(card);
            });
            
            actualizarSelectMesas();
        };

        // Reservar una mesa
        function reservarMesa(i) {
            // Verificar si la mesa ya est√° ocupada por una reserva confirmada
            if (mesas[i].estado === "Ocupada") {
                Swal.fire({
                    icon: 'error',
                    title: 'Mesa no disponible',
                    text: 'Esta mesa ya est√° ocupada por una reserva confirmada'
                });
                return;
            }
            
            mesas[i].estado = "Ocupada";
            localStorage.setItem("mesas", JSON.stringify(mesas));
            pintarDatos();
            actualizarEstadisticas();
            
            document.getElementById("select-mesa").value = mesas[i].numero;
            mostrarFormularioNew();
        }

        // Editar una mesa
        window.editarMesa = (i) => {
            const mesa = mesas[i];
            editIndex = i;
            
            document.getElementById("modal-numero").value = mesa.numero;
            document.getElementById("modal-cantidad").value = mesa.cantidad;
            document.getElementById("modal-ubicacion").value = mesa.ubicacion;
            document.getElementById("modal-estado").value = mesa.estado;
            
            document.getElementById("modalMesasLabel").textContent = "Editar mesa";
            
            // Limpiar errores
            document.getElementById("errorCantidad").style.display = "none";
            document.getElementById("modal-cantidad").classList.remove("input-error");
            
            const modal = new bootstrap.Modal(document.getElementById("modalMesas"));
            modal.show();
        };

        // Eliminar una mesa
        window.eliminarMesa = (i) => {
            Swal.fire({
                title: '¬øEst√° seguro?',
                text: "Esta acci√≥n no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    mesas.splice(i, 1);
                    localStorage.setItem("mesas", JSON.stringify(mesas));
                    pintarDatos();
                    actualizarEstadisticas();
                    Swal.fire(
                        'Eliminada!',
                        'La mesa ha sido eliminada.',
                        'success'
                    );
                }
            });
        };

        // Mostrar formulario de reserva
        function mostrarFormularioNew() {
            document.getElementById("formulario").style.display = "block";
            document.getElementById("btnReserva").style.display = "none";
            
            // Generar ID √∫nico para la reserva
            document.getElementById("idreserva").value = Math.floor(1000 + Math.random() * 9000);
            
            // Establecer fecha m√≠nima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("Datereserva").setAttribute('min', today);
            document.getElementById("Datereserva").value = today;
            
            // Establecer hora actual por defecto
            const ahora = new Date();
            const horas = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            document.getElementById("hora-reserva").value = `${horas}:${minutos}`;
        }

        // Ocultar formulario de reserva
        function ocultarFormularioNew() {
            document.getElementById("formulario").style.display = "none";
            document.getElementById("btnReserva").style.display = "block";
            limpiarFormularioNew();
        }

        // Limpiar formulario de reserva
        function limpiarFormularioNew() {
            document.getElementById("idreserva").value = "";
            document.getElementById("nombreCliente").value = "";
            document.getElementById("NumReservas").value = "";
            document.getElementById("Datereserva").value = "";
            document.getElementById("hora-reserva").value = "";
            document.getElementById("Notas").value = "";
            document.getElementById("estado").value = "Pendiente";
            document.getElementById("select-mesa").value = "";
            
            // Limpiar errores
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
        }

        // Guardar reserva
        function guardarNew() {
            // Validaciones
            let isValid = true;
            
            if (!document.getElementById("nombreCliente").value) {
                document.getElementById("nombreCliente").classList.add('input-error');
                document.getElementById("errorNombre").style.display = 'block';
                isValid = false;
            }
            
            if (!document.getElementById("NumReservas").value || document.getElementById("NumReservas").value < 1) {
                document.getElementById("NumReservas").classList.add('input-error');
                document.getElementById("errorNombre1").style.display = 'block';
                isValid = false;
            }
            
            if (!document.getElementById("Datereserva").value) {
                document.getElementById("Datereserva").classList.add('input-error');
                document.getElementById("errorNombre2").style.display = 'block';
                isValid = false;
            }
            
            // Validar hora de reserva (entre 8:00 y 20:00)
            const horaReserva = document.getElementById("hora-reserva").value;
            if (!horaReserva) {
                document.getElementById("hora-reserva").classList.add('input-error');
                document.getElementById("errorHora").style.display = 'block';
                isValid = false;
            } else if (horaReserva < "08:00" || horaReserva > "20:00") {
                document.getElementById("hora-reserva").classList.add('input-error');
                document.getElementById("errorHora").textContent = "‚ö†Ô∏è El horario debe ser entre 8:00 AM y 8:00 PM";
                document.getElementById("errorHora").style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;
            
            // Verificar si la mesa seleccionada sigue disponible
            const mesaSeleccionada = document.getElementById("select-mesa").value;
            const mesaIndex = mesas.findIndex(m => m.numero == mesaSeleccionada);
            


            
            if (mesaIndex === -1 || mesas[mesaIndex].estado !== "Libre") {
                Swal.fire({
                    icon: 'error',
                    title: 'Mesa no disponible',
                    text: 'La mesa seleccionada ya no est√° disponible. Por favor, elija otra mesa.'
                });
                return;
            }
            
            // Crear objeto de reserva
            let reg = {
                id: document.getElementById("idreserva").value,
                mesa: mesaSeleccionada,
                cliente: document.getElementById("nombreCliente").value,
                personas: document.getElementById("NumReservas").value,
                fecha: document.getElementById("Datereserva").value,
                hora: document.getElementById("hora-reserva").value,
                duracion: document.getElementById("duracion-reserva").value,
                ocasion: document.getElementById("ocasiones-especiales").value,
                notas: document.getElementById("Notas").value,
                estado: document.getElementById("estado").value,
                // Guardar timestamp de inicio si la reserva est√° confirmada u ocupada
                startTime: (document.getElementById("estado").value === "Confirmada" || 
                           document.getElementById("estado").value === "Ocupada") ? Date.now() : null
            };
            
            datos.push(reg);
            localStorage.setItem("reservas", JSON.stringify(datos));
            

            if (reg.estado === "Confirmada" || reg.estado === "Ocupada" || reg.estado === "Pendiente") {
    mesas[mesaIndex].estado = "Ocupada";
    localStorage.setItem("mesas", JSON.stringify(mesas));

    // Iniciar temporizador solo para reservas Confirmadas u Ocupadas
    if (reg.estado === "Confirmada" || reg.estado === "Ocupada") {
        iniciarTemporizador(reg.id, reg.startTime, parseInt(reg.duracion));
    }
}
            // Actualizar estado de la mesa si est√° reservada
            
            pintarDatos();
            pintarDatosNew();
            actualizarEstadisticas();
            ocultarFormularioNew();
            
            Swal.fire('Reserva guardada con √©xito!', '', 'success');
        }

        // Pintar reservas en la tabla
        function pintarDatosNew() {
            const infoData = document.getElementById("infoData");
            const filtroConfirmadas = document.getElementById("filtroConfirmadas");

            infoData.innerHTML = "";         // Limpia tabla principal
            filtroConfirmadas.innerHTML = ""; // Limpia la secci√≥n de confirmadas

            datos.forEach((item, i) => {
                // üéØ Crear fila normal
                let tr = document.createElement("tr");
                
                // Calcular tiempo transcurrido si hay startTime
                let tiempoInfo = "";
                if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada")) {
                    tiempoInfo = `<td id="temporizador-${item.id}" class="temporizador-info">‚åõ Calculando...</td>`;
                } else {
                    tiempoInfo = "<td>-</td>";
                }
                
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.mesa}</td>
                    <td>${item.cliente}</td>
                    <td>${item.personas}</td>
                    <td>${item.fecha}</td>
                    <td>${item.hora || '-'}</td>
                    <td>${item.duracion ? (item.duracion / 6) + ' h' : '-'}</td>
                    <td>${item.ocasion}</td>
                    <td>${item.notas}</td>
                    <td>
                        <span class="badge ${item.estado === 'Confirmada' ? 'bg-success' : 
                                        item.estado === 'Pendiente' ? 'bg-warning' : 
                                        item.estado === 'Cancelada' ? 'bg-danger' : 
                                        item.estado === 'Ocupada' ? 'bg-primary' : 'bg-secondary'}">
                            ${item.estado}
                        </span>
                    </td>
                    ${tiempoInfo}
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarReservaNew(${i})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarReservaNew(${i})">üóëÔ∏è Eliminar</button>
                        ${item.estado === 'Confirmada' || item.estado === 'Ocupada' ? 
                        `<button class="btn btn-success btn-sm mt-1" onclick="pagarCuenta(${i})">üíµ Pagar</button>` : ''}
                    </td>
                `;
                infoData.appendChild(tr);

                // Iniciar temporizador si corresponde
                if (item.startTime && (item.estado === "Confirmada" || item.estado === "Ocupada")) {
                    iniciarTemporizador(item.id, parseInt(item.startTime), parseInt(item.duracion));
                }

                // üéØ Si es confirmada u ocupada, agregamos su info a la secci√≥n especial
                if (item.estado === "Confirmada" || item.estado === "Pendiente") {
                    let div = document.createElement("div");
                    div.classList.add("card", "p-2", "mb-2", "border", "rounded");
                    
                    if (item.estado === "Confirmada") {
                        div.classList.add("border-success");
                        div.style.background = "linear-gradient(to right, #ffe259, #ffa751)";
                    } else {
                        div.classList.add("border-primary");
                        div.style.background = "linear-gradient(to right, #4facfe, #00f2fe)";
                        div.style.color = "white";
                    }
                    
                    // Calcular tiempo restante si hay startTime
                    let tiempoRestanteInfo = "";
                    if (item.startTime && item.duracion) {
                        const ahora = Date.now();
                        const tiempoTranscurrido = Math.floor((ahora - item.startTime) / 60000);
                        const tiempoRestante = item.duracion - tiempoTranscurrido;
                        
                        if (tiempoRestante > 0) {
                            tiempoRestanteInfo = `<br><strong>Tiempo restante:</strong> ${tiempoRestante} minutos`;
                        } else {
                            tiempoRestanteInfo = `<br><strong class="temporizador-activo">‚è∞ Tiempo cumplido</strong>`;
                        }
                    }
                    
                    div.innerHTML = `
                        <h4>Mesa ${item.estado.toLowerCase()}</h4>
                        <strong>Mesa:</strong> ${item.mesa} |
                        <strong>Cliente:</strong> ${item.cliente} |
                        <strong>Hora:</strong> ${item.hora}${tiempoRestanteInfo}
                    `;

                    filtroConfirmadas.appendChild(div);
                } else if (item.estado === "Pendiente") {
                    let div2 = document.createElement("div");
                    div2.classList.add("card", "p-2", "mb-2", "border", "border-warning", "rounded");
                    div2.style.background = "rgb(255, 255, 200)";
                    div2.innerHTML = `
                        <h4>Reserva Pendiente</h4>
                        <strong>Mesa:</strong> ${item.mesa} |
                        <strong>Cliente:</strong> ${item.cliente} |
                        <strong>Fecha:</strong> ${item.fecha} |
                        <strong>Hora:</strong> ${item.hora}
                    `;

                    filtroConfirmadas.appendChild(div2);
                }
            });
        }

        // Editar reserva
        function editarReservaNew(i) {
            let item = datos[i];
            
            document.getElementById("idreserva").value = item.id;
            document.getElementById("select-mesa").value = item.mesa;
            document.getElementById("nombreCliente").value = item.cliente;
            document.getElementById("NumReservas").value = item.personas;
            document.getElementById("Datereserva").value = item.fecha;
            document.getElementById("hora-reserva").value = item.hora || "";
            document.getElementById("duracion-reserva").value = item.duracion || "120";
            document.getElementById("ocasiones-especiales").value = item.ocasion;
            document.getElementById("Notas").value = item.notas;
            document.getElementById("estado").value = item.estado;
            
            document.getElementById("formulario").style.display = "block";
            document.getElementById("btnReserva").style.display = "none";
            
            datos.splice(i, 1);
            localStorage.setItem("reservas", JSON.stringify(datos));
            pintarDatosNew();
        }

        // Eliminar reserva
        function eliminarReservaNew(i) {
            Swal.fire({
                title: '¬øEst√° seguro?',
                text: "Esta acci√≥n no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Detener temporizador si est√° activo
                    const reservaId = datos[i].id;
                    if (temporizadoresActivos[reservaId]) {
                        clearInterval(temporizadoresActivos[reservaId]);
                        delete temporizadoresActivos[reservaId];
                    }
                    
                    // Liberar la mesa si la reserva estaba activa
                
                    if (datos[i].estado === "Confirmada" || datos[i].estado === "Ocupada" || datos[i].estado === "Pendiente") {
    const mesaIndex = mesas.findIndex(m => m.numero == datos[i].mesa);
    if (mesaIndex !== -1) {
        mesas[mesaIndex].estado = "Libre";
        localStorage.setItem("mesas", JSON.stringify(mesas));
        pintarDatos();
    }
}
                    
                    datos.splice(i, 1);
                    localStorage.setItem("reservas", JSON.stringify(datos));
                    pintarDatosNew();
                    actualizarEstadisticas();
                    Swal.fire(
                        'Eliminada!',
                        'La reserva ha sido eliminada.',
                        'success'
                    );
                }
            });
        }

        // Pagar cuenta
        function pagarCuenta(i) {
            let item = datos[i];
            item.estado = "Finalizada";
            
            // Detener temporizador si est√° activo
            if (temporizadoresActivos[item.id]) {
                clearInterval(temporizadoresActivos[item.id]);
                delete temporizadoresActivos[item.id];
            }
            
            // Liberar la mesa
            const mesaIndex = mesas.findIndex(m => m.numero == item.mesa);
            if (mesaIndex !== -1) {
                mesas[mesaIndex].estado = "Libre";
                localStorage.setItem("mesas", JSON.stringify(mesas));
                pintarDatos();
            }
            
            localStorage.setItem("reservas", JSON.stringify(datos));
            pintarDatosNew();
            actualizarEstadisticas();
            
            Swal.fire(`La cuenta de ${item.cliente} (Mesa ${item.mesa}) ha sido pagada ‚úÖ`, '', 'success');
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            document.getElementById("total-mesas").textContent = mesas.length;
            document.getElementById("mesas-libres").textContent = mesas.filter(m => m.estado === "Libre").length;
            document.getElementById("total-reservas").textContent = datos.length;
            
            // Mostrar reservas de hoy
            const today = new Date().toISOString().split('T')[0];
            const reservasHoy = datos.filter(r => r.fecha === today);
            const reservasHoyContainer = document.getElementById("reservas-hoy");
            
            if (reservasHoy.length === 0) {
                reservasHoyContainer.innerHTML = '<div class="text-center p-3 border rounded">No hay reservas para hoy</div>';
            } else {
                let html = '';
                reservasHoy.forEach(r => {
                    html += `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>Mesa ${r.mesa}</strong>
                                <span class="badge bg-primary">${r.estado}</span>
                            </div>
                            <div>${r.cliente} (${r.personas} personas)</div>
                            <div>Hora: ${r.hora}</div>
                            <small class="text-muted">${r.ocasion}</small>
                        </div>
                    `;
                });
                reservasHoyContainer.innerHTML = html;
            }
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener("DOMContentLoaded", function() {
            pintarDatos();
            pintarDatosNew();
            actualizarEstadisticas();
            recuperarTemporizadores();
            document.getElementById("btnGuardarModal").addEventListener("click", guardarDesdeModal);
        });
    </script>
</body>
</html>
